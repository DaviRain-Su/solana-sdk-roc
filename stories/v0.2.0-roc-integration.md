# Story: v0.2.0 Roc 集成

> 将 Roc 编译器输出集成到 Solana 程序中，实现 Roc 代码在链上执行

## 状态

- 开始日期: 2025-01-03
- 完成日期: 2025-01-04
- 状态: ✅ 已完成

## 目标

1. ✅ 使用 solana-zig-bootstrap 作为统一工具链
2. ✅ 修改 Roc 编译器支持 SBF 目标
3. ✅ 将 Roc 应用编译为 LLVM 位码
4. ✅ 将 Roc 位码与 Zig 宿主链接
5. ✅ 验证 Roc 代码在链上正确执行
6. ✅ **字符串插值支持** (额外完成)

## 验收标准

### Roc 编译器修改
- [x] 添加 `target-bpf` Cargo feature
- [x] 修复 LLVM 三元组 (`sbf-solana-solana`)
- [x] 修复 SBF 字符串/列表 ABI
- [x] 避免不支持的 LLVM 内联函数
- [x] 生成补丁文件

### Host 实现
- [x] 入口点 (`entrypoint`)
- [x] 内存管理 (`roc_alloc`, `roc_dealloc`, `roc_realloc`)
- [x] 辅助函数 (`roc_panic`, `roc_dbg`)
- [x] SBF 特定函数 (`memcpy_c`, `memset_c`)
- [x] RocStr SSO 解码

### 构建系统
- [x] build.zig 完整流程
- [x] Roc → LLVM BC → SBF Object → .so

### 测试
- [x] Hello World
- [x] Fibonacci (递归)
- [x] Fibonacci (迭代)
- [x] 字符串插值

### 文档
- [x] 完整历程文档
- [x] 编译指南
- [x] 修改说明
- [x] 补丁文件

## 测试结果

| 测试 | 输出 | 计算单元 |
|------|------|----------|
| Hello World | "Hello Solana!" | ~127 CU |
| 递归 Fib(15) | 610 | ~20,842 CU |
| 迭代 Fib(50) | 12586269025 | ~831 CU |
| 字符串插值 Fib(10) | "Fib(10) = 55" | ~2,339 CU |

## 关键修复

### 1. LLVM 三元组
```zig
// src/target/mod.zig
.sbfsolana => "sbf-solana-solana",  // 修复
```

### 2. 字符串/列表 ABI
```rust
// bitcode.rs - 为 SBF 加载结构体值
if is_sbf {
    let str_value = env.builder.new_build_load(str_type, str_ptr, "load_str");
    arguments.push(str_value);
}
```

### 3. memcpy_c 外部函数
```zig
// utils.zig - 声明外部函数
extern fn memcpy_c(dest: [*]u8, src: [*]const u8, n: usize) callconv(.c) [*]u8;

// host.zig - 导出实现
pub export fn memcpy_c(...) callconv(.c) [*]u8 { ... }
```

## 产出物

- `docs/roc-sbf-complete.patch` - 完整补丁 (4600+ 行)
- `docs/roc-build-guide.md` - 编译指南
- `docs/journey-from-zero-to-success.md` - 完整历程

## 下一步 (v0.3.0)

- [ ] 账户读取支持
- [ ] 指令数据解析
- [ ] CPI 跨程序调用
