# Story: v0.2.0 真正的 Roc 集成

> 将 Roc 编译器输出真正集成到 Solana 程序中，实现 Roc 代码在链上执行

## 目标

1. 使用 solana-zig-bootstrap 作为统一工具链
2. 用 solana-zig 重新编译 Roc 编译器
3. 将 Roc 应用编译为 LLVM 位码
4. 将 Roc 位码与 Zig 宿主链接
5. 验证 Roc 代码在链上正确执行

## 技术方案

### 新架构（基于 solana-zig-bootstrap）

```
┌─────────────────────────────────────────────────────────────────┐
│              solana-zig-bootstrap (./solana-zig/zig)            │
│                  Zig 0.15.2 + 原生 SBF 目标                      │
└─────────────────────────────────────────────────────────────────┘
                               │
             ┌─────────────────┴─────────────────┐
             ↓                                   ↓
┌───────────────────────┐         ┌───────────────────────────────┐
│     Roc 编译器         │         │   solana-program-sdk-zig      │
│  (用 solana-zig 编译)  │         │   (原生 SBF 支持)              │
└───────────────────────┘         └───────────────────────────────┘
             │                                   │
             ↓                                   ↓
┌─────────────────────────────────────────────────────────────────┐
│    examples/hello-world/app.roc  +  src/host.zig                │
│                                                                   │
│    编译目标: sbf-freestanding (原生 SBF)                         │
│    无需 sbpf-linker                                              │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                   Solana eBPF 程序 (.so)                         │
│                   部署到 devnet/testnet                          │
└─────────────────────────────────────────────────────────────────┘
```

### 编译流程

```
阶段 1: 准备工具链
    ./solana-zig/zig (已有，支持 sbf-freestanding)
        ↓
阶段 2: 编译 Roc 编译器
    cd roc-source && ../solana-zig/zig build
        ↓
阶段 3: 编译 Roc 应用
    ./roc-source/zig-out/bin/roc build --emit-llvm-bc app.roc
        ↓
阶段 4: 编译并链接
    ./solana-zig/zig build -Dtarget=sbf-freestanding
        ↓
roc-hello.so (Solana eBPF 程序)
```

## 验收标准

### 阶段 1: 工具链验证
- [x] 获取 solana-zig-bootstrap (./solana-zig/)
- [x] 验证 SBF 目标支持 (`./solana-zig/zig targets | grep sbf`)
- [x] 验证版本 (Zig 0.15.2)
- [ ] 测试简单 SBF 程序编译

### 阶段 2: Roc 编译器编译
- [ ] 配置 roc-source 使用 solana-zig
- [ ] 解决编译依赖问题
- [ ] 成功编译 Roc 编译器
- [ ] 验证 Roc 编译器可用 (`./zig-out/bin/roc version`)

### 阶段 3: 平台和应用

#### platform/main.roc
- [ ] 定义正确的平台接口 (requires, exposes, provides)
- [ ] 导出 mainForHost 函数
- [ ] 通过 Roc 编译器验证

#### examples/hello-world/app.roc
- [ ] 正确引用平台
- [ ] 返回自定义字符串
- [ ] 通过 Roc 编译器验证

### 阶段 4: Zig 宿主集成

#### src/host.zig
- [ ] 声明 extern fn roc__mainForHost_1_exposed_generic
- [ ] 在 entrypoint 中调用 Roc 的 mainForHost
- [ ] 获取 Roc 返回的字符串并输出到日志
- [ ] RocStr ABI 匹配 (16 字节: ptr + u32 len + u32 cap)

#### build.zig
- [ ] 更新使用 solana-zig 而非系统 zig
- [ ] 配置 sbf-freestanding 目标
- [ ] 添加 Roc 编译步骤
- [ ] 链接 Roc 生成的对象文件

### 阶段 5: 测试和部署
- [ ] Zig 构建成功 (`./solana-zig/zig build test`)
- [ ] 生成有效的 SBF 字节码
- [ ] 部署到本地测试网成功
- [ ] 调用程序并验证日志输出来自 Roc 代码

### 阶段 6: 文档
- [x] 更新 docs/new-architecture-plan.md
- [x] 更新 docs/build-integration.md
- [x] 更新 docs/challenges-solutions.md
- [ ] 更新 README.md

## 完成状态

- 开始日期: 2026-01-03
- 完成日期: -
- 状态: ⏳ 进行中

## 历史挑战（旧方案，已通过新方案解决）

### 挑战 1: Roc 不支持 BPF 目标 ✅ 已解决
- **旧方案**: 用 `roc build --emit-llvm-ir` 生成 IR，手动转换
- **新方案**: 用 solana-zig 重新编译 Roc，获得原生 SBF 支持

### 挑战 2: BPF 不支持复杂操作 ⏳ 待验证
- BPF 不支持 128 位整数运算
- BPF 不支持浮点运算
- **解决**: 在 Roc 代码中避免这些操作

### 挑战 3: LLVM 版本不兼容 ✅ 已解决
- **旧方案**: Zig 使用 LLVM 20，系统安装 LLVM 18
- **新方案**: solana-zig 使用统一的 LLVM 版本

### 挑战 4: sbpf-linker 多文件链接问题 ✅ 已解决
- **旧方案**: "Relocations found but no .rodata section"
- **新方案**: 使用 solana-zig 原生链接器，无需 sbpf-linker

### 挑战 5: 内存分配器 ✅ 已解决
- 在 v0.1.0 实现使用 Solana bump allocator

## 与 v0.1.0 的关系

v0.1.0 实现了纯 Zig 的 Solana 程序：
- ✅ Zig 宿主代码 (src/host.zig)
- ✅ Roc 运行时接口 (roc_alloc, roc_panic, etc.)
- ✅ 使用 solana-program-sdk-zig
- ✅ 成功部署到测试网

v0.2.0 在此基础上添加真正的 Roc 集成：
- ⏳ 用 solana-zig 编译 Roc 编译器
- ⏳ Roc 平台定义
- ⏳ Roc 应用示例
- ⏳ Roc + Zig 链接

## 下一步 (v0.3.0)

- [ ] 支持 Roc 效果系统映射到 Solana syscalls
- [ ] 实现账户操作 (读取/写入账户数据)
- [ ] 支持 CPI (跨程序调用)

## 参考资源

- [solana-zig-bootstrap](https://github.com/joncinque/solana-zig-bootstrap)
- [solana-program-sdk-zig](https://github.com/joncinque/solana-program-sdk-zig)
- [Roc 语言](https://github.com/roc-lang/roc)
- [docs/new-architecture-plan.md](../docs/new-architecture-plan.md)
