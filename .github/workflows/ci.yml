name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SOLANA_ZIG_VERSION: "solana-v1.52.0"

jobs:
  cli-build:
    name: Build CLI
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: "0.15.2"

      - name: Build CLI
        working-directory: cli
        run: zig build

      - name: Test CLI help
        working-directory: cli
        run: ./zig-out/bin/roc-solana help

      - name: Test CLI init
        working-directory: cli
        run: |
          ./zig-out/bin/roc-solana init test-project
          ls -la test-project/
          cat test-project/app/main.roc

  solana-build:
    name: Build Solana Program
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache solana-zig
        id: cache-solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-x86_64-linux

      - name: Download solana-zig
        if: steps.cache-solana-zig.outputs.cache-hit != 'true'
        run: |
          curl -L "https://github.com/joncinque/solana-zig-bootstrap/releases/download/${{ env.SOLANA_ZIG_VERSION }}/zig-x86_64-linux-musl.tar.bz2" -o zig.tar.bz2
          mkdir -p solana-zig
          tar -xjf zig.tar.bz2 -C solana-zig --strip-components=1
          rm zig.tar.bz2

      - name: Verify solana-zig
        run: ./solana-zig/zig version

      - name: Fetch dependencies
        run: ./solana-zig/zig build --fetch

      - name: Build host test
        run: ./solana-zig/zig build test

      - name: Check platform files
        run: |
          ls -la platform/
          cat platform/main.roc

  generated-project-build:
    name: Test Generated Project
    runs-on: ubuntu-latest
    needs: cli-build

    steps:
      - uses: actions/checkout@v4

      - name: Cache solana-zig
        id: cache-solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-x86_64-linux

      - name: Download solana-zig
        if: steps.cache-solana-zig.outputs.cache-hit != 'true'
        run: |
          curl -L "https://github.com/joncinque/solana-zig-bootstrap/releases/download/${{ env.SOLANA_ZIG_VERSION }}/zig-x86_64-linux-musl.tar.bz2" -o zig.tar.bz2
          mkdir -p solana-zig
          tar -xjf zig.tar.bz2 -C solana-zig --strip-components=1
          rm zig.tar.bz2

      - name: Install standard Zig (for CLI build)
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: "0.15.2"

      - name: Build CLI
        working-directory: cli
        run: zig build

      - name: Generate test project
        run: ./cli/zig-out/bin/roc-solana init test-generated

      - name: Show generated project structure
        run: |
          echo "=== Generated Project Structure ==="
          find test-generated -type f | head -20
          echo ""
          echo "=== build.zig ==="
          cat test-generated/build.zig

      - name: Fetch dependencies
        working-directory: test-generated
        run: ../solana-zig/zig build --fetch

      - name: Build generated project
        working-directory: test-generated
        run: ../solana-zig/zig build

      - name: Verify output
        run: |
          echo "=== Build Output ==="
          ls -la test-generated/zig-out/lib/ || echo "No lib output (expected if no .roc app)"

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check file structure
        run: |
          echo "=== Project Structure ==="
          find . -type f -name "*.zig" -o -name "*.roc" | grep -v node_modules | grep -v .zig-cache | head -20
          
          echo ""
          echo "=== Required files ==="
          test -f build.zig && echo "✓ build.zig"
          test -f build.zig.zon && echo "✓ build.zig.zon"
          test -f src/host.zig && echo "✓ src/host.zig"
          test -f platform/main.roc && echo "✓ platform/main.roc"
          test -f cli/src/main.zig && echo "✓ cli/src/main.zig"

      - name: Check docs
        run: |
          echo "=== Documentation ==="
          test -f README.md && echo "✓ README.md"
          test -f docs/roc-sbf-complete.patch && echo "✓ docs/roc-sbf-complete.patch"
          test -f docs/roc-build-guide.md && echo "✓ docs/roc-build-guide.md"
